<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יצירת מוזיקה עם Lyria RealTime</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        button {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #audioPlayer {
            width: 100%;
            margin-top: 20px;
        }
        #status {
            margin-top: 10px;
            font-style: italic;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>יצירת מוזיקה באמצעות Lyria RealTime</h1>
        <p>הזן את מפתח ה-API של Gemini, כתוב הנחיה, והתחל ליצור מוזיקה!</p>
        
        <label for="apiKey">מפתח API:</label>
        <input type="text" id="apiKey" placeholder="הזן כאן את מפתח ה-API">
        
        <label for="prompt">הנחיה ראשונית (prompt):</label>
        <textarea id="prompt" rows="4" placeholder="לדוגמה: Minimal techno with deep bass"></textarea>
        
        <label for="bpm">BPM (קצב):</label>
        <input type="number" id="bpm" min="60" max="200" value="90">
        
        <label for="temperature">Temperature (יצירתיות):</label>
        <input type="number" id="temperature" min="0" max="3" step="0.1" value="1.0">
        
        <label for="density">Density (צפיפות):</label>
        <input type="number" id="density" min="0" max="1" step="0.1" value="0.5">
        
        <label for="brightness">Brightness (בהירות):</label>
        <input type="number" id="brightness" min="0" max="1" step="0.1" value="0.5">
        
        <label for="scale">סולם מוזיקלי:</label>
        <select id="scale">
            <option value="SCALE_UNSPECIFIED">ברירת מחדל</option>
            <option value="C_MAJOR_A_MINOR">דו מז'ור / לה מינור</option>
            <option value="D_FLAT_MAJOR_B_FLAT_MINOR">רה במול מז'ור / סי במול מינור</option>
            <option value="D_MAJOR_B_MINOR">רה מז'ור / סי מינור</option>
            <option value="E_FLAT_MAJOR_C_MINOR">מי במול מז'ור / דו מינור</option>
            <option value="E_MAJOR_D_FLAT_MINOR">מי מז'ור / רה במול מינור</option>
            <option value="F_MAJOR_D_MINOR">פה מז'ור / רה מינור</option>
            <option value="G_FLAT_MAJOR_E_FLAT_MINOR">סול במול מז'ור / מי במול מינור</option>
            <option value="G_MAJOR_E_MINOR">סול מז'ור / מי מינור</option>
            <option value="A_FLAT_MAJOR_F_MINOR">לה במול מז'ור / פה מינור</option>
            <option value="A_MAJOR_G_FLAT_MINOR">לה מז'ור / סול במול מינור</option>
            <option value="B_FLAT_MAJOR_G_MINOR">סי במול מז'ור / סול מינור</option>
            <option value="B_MAJOR_A_FLAT_MINOR">סי מז'ור / לה במול מינור</option>
        </select>
        
        <label for="muteBass">השתק בס:</label>
        <input type="checkbox" id="muteBass">
        
        <label for="muteDrums">השתק תופים:</label>
        <input type="checkbox" id="muteDrums">
        
        <label for="onlyBassDrums">רק בס ותופים:</label>
        <input type="checkbox" id="onlyBassDrums">
        
        <label for="mode">מצב יצירה:</label>
        <select id="mode">
            <option value="QUALITY">איכות</option>
            <option value="DIVERSITY">מגוון</option>
            <option value="VOCALIZATION">ווקאליזציה</option>
        </select>
        
        <button id="startButton">התחל יצירה</button>
        
        <div class="controls hidden" id="liveControls">
            <label for="newPrompt">הנחיה חדשה (בזמן אמת):</label>
            <textarea id="newPrompt" rows="2" placeholder="שנה את המוזיקה..."></textarea>
            <label for="newWeight">משקל להנחיה החדשה:</label>
            <input type="number" id="newWeight" min="0" step="0.1" value="1.0">
            <button id="updatePrompt">עדכן הנחיה</button>
            
            <button id="pauseButton">השהה</button>
            <button id="resumeButton">המשך</button>
            <button id="stopButton">עצור</button>
            <button id="resetButton">אפס</button>
            <button id="downloadButton">הורד אודיו</button>
        </div>
        
        <audio id="audioPlayer" controls></audio>
        <div id="status"></div>
    </div>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.sh/@google/genai';

        let client;
        let session;
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioBuffers = []; // raw PCM bytes for download
        let bufferQueue = []; // decoded AudioBuffers for playing
        let isPlaying = false;
        const sampleRate = 48000; // Based on docs
        const channels = 2;
        const bitDepth = 16;

        const apiKeyInput = document.getElementById('apiKey');
        const promptInput = document.getElementById('prompt');
        const bpmInput = document.getElementById('bpm');
        const temperatureInput = document.getElementById('temperature');
        const densityInput = document.getElementById('density');
        const brightnessInput = document.getElementById('brightness');
        const scaleSelect = document.getElementById('scale');
        const muteBassCheckbox = document.getElementById('muteBass');
        const muteDrumsCheckbox = document.getElementById('muteDrums');
        const onlyBassDrumsCheckbox = document.getElementById('onlyBassDrums');
        const modeSelect = document.getElementById('mode');
        const startButton = document.getElementById('startButton');
        const updatePromptButton = document.getElementById('updatePrompt');
        const newPromptInput = document.getElementById('newPrompt');
        const newWeightInput = document.getElementById('newWeight');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const stopButton = document.getElementById('stopButton');
        const resetButton = document.getElementById('resetButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusDiv = document.getElementById('status');
        const liveControls = document.getElementById('liveControls');
        const audioPlayer = document.getElementById('audioPlayer');

        startButton.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                statusDiv.textContent = 'נא להזין מפתח API תקף.';
                return;
            }
            const prompt = promptInput.value.trim();
            if (!prompt) {
                statusDiv.textContent = 'נא להזין הנחיה.';
                return;
            }

            statusDiv.textContent = 'מתחבר...';
            client = new GoogleGenAI({ apiKey, apiVersion: "v1alpha" });

            try {
                session = await client.live.music.connect({
                    model: "models/lyria-realtime-exp",
                    callbacks: {
                        onmessage: (message) => {
                            if (message.serverContent?.audioChunks) {
                                for (const chunk of message.serverContent.audioChunks) {
                                    const base64Data = chunk.data;
                                    const pcmBytes = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                                    audioBuffers.push(pcmBytes);
                                    createAndQueueBuffer(pcmBytes);
                                }
                            }
                        },
                        onerror: (error) => {
                            console.error("שגיאה:", error);
                            statusDiv.textContent = 'שגיאה: ' + error.message;
                        },
                        onclose: () => {
                            statusDiv.textContent = 'זרם נסגר.';
                        }
                    }
                });

                await session.setWeightedPrompts({
                    weightedPrompts: [{ text: prompt, weight: 1.0 }]
                });

                await session.setMusicGenerationConfig({
                    musicGenerationConfig: {
                        bpm: parseInt(bpmInput.value),
                        temperature: parseFloat(temperatureInput.value),
                        density: parseFloat(densityInput.value),
                        brightness: parseFloat(brightnessInput.value),
                        scale: scaleSelect.value,
                        mute_bass: muteBassCheckbox.checked,
                        mute_drums: muteDrumsCheckbox.checked,
                        only_bass_and_drums: onlyBassDrumsCheckbox.checked,
                        music_generation_mode: modeSelect.value,
                        audioFormat: "pcm16",
                        sampleRateHz: sampleRate
                    }
                });

                await session.play();
                statusDiv.textContent = 'מוזיקה מנגנת!';
                liveControls.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                statusDiv.textContent = 'שגיאה בהתחברות: ' + error.message;
            }
        });

        updatePromptButton.addEventListener('click', async () => {
            const newPrompt = newPromptInput.value.trim();
            if (!newPrompt || !session) return;
            await session.setWeightedPrompts({
                weightedPrompts: [{ text: newPrompt, weight: parseFloat(newWeightInput.value) }]
            });
            statusDiv.textContent = 'הנחיה עודכנה!';
        });

        pauseButton.addEventListener('click', async () => {
            if (session) await session.pause();
            statusDiv.textContent = 'מושהה.';
        });

        resumeButton.addEventListener('click', async () => {
            if (session) await session.play();
            statusDiv.textContent = 'ממשיך.';
        });

        stopButton.addEventListener('click', async () => {
            if (session) await session.stop();
            statusDiv.textContent = 'עצר.';
        });

        resetButton.addEventListener('click', async () => {
            if (session) await session.reset_context();
            audioBuffers = [];
            bufferQueue = [];
            statusDiv.textContent = 'אופס.';
        });

        downloadButton.addEventListener('click', () => {
            if (audioBuffers.length === 0) {
                statusDiv.textContent = 'אין אודיו להורדה.';
                return;
            }
            const combinedPcm = concatenateUint8Arrays(audioBuffers);
            const wavBlob = createWavBlob(combinedPcm);
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'music.wav';
            a.click();
            URL.revokeObjectURL(url);
        });

        function createAndQueueBuffer(pcmBytes) {
            const frameCount = pcmBytes.length / (channels * (bitDepth / 8));
            const audioBuffer = audioContext.createAudioBuffer(channels, frameCount, sampleRate);
            const pcmData = new Int16Array(pcmBytes.buffer);

            for (let i = 0; i < frameCount; i++) {
                for (let ch = 0; ch < channels; ch++) {
                    const sample = pcmData[i * channels + ch];
                    audioBuffer.getChannelData(ch)[i] = sample / 32768; // Normalize to [-1, 1]
                }
            }

            bufferQueue.push(audioBuffer);
            if (!isPlaying) {
                playNextBuffer();
            }
        }

        function playNextBuffer() {
            if (bufferQueue.length === 0) {
                isPlaying = false;
                return;
            }
            isPlaying = true;
            const buffer = bufferQueue.shift();
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.onended = playNextBuffer;
            source.start();
        }

        function concatenateUint8Arrays(arrays) {
            const totalLength = arrays.reduce((acc, val) => acc + val.length, 0);
            const result = new Uint8Array(totalLength);
            let offset = 0;
            for (const arr of arrays) {
                result.set(arr, offset);
                offset += arr.length;
            }
            return result;
        }

        function createWavBlob(pcmData) {
            const header = createWavHeader(sampleRate, channels, bitDepth, pcmData.length);
            const wav = new Uint8Array(header.length + pcmData.length);
            wav.set(header, 0);
            wav.set(pcmData, header.length);
            return new Blob([wav], { type: 'audio/wav' });
        }

        function createWavHeader(sampleRate, channels, bitDepth, dataLength) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            // RIFF identifier
            view.setUint32(0, 0x52494646, false); // 'RIFF'

            // File size
            view.setUint32(4, 36 + dataLength, true);

            // RIFF form type
            view.setUint32(8, 0x57415645, false); // 'WAVE'

            // Format chunk identifier
            view.setUint32(12, 0x666d7420, false); // 'fmt '

            // Format chunk size
            view.setUint32(16, 16, true);

            // Sample format (1 = PCM)
            view.setUint16(20, 1, true);

            // Number of channels
            view.setUint16(22, channels, true);

            // Sample rate
            view.setUint32(24, sampleRate, true);

            // Byte rate
            view.setUint32(28, sampleRate * channels * (bitDepth / 8), true);

            // Block align
            view.setUint16(32, channels * (bitDepth / 8), true);

            // Bits per sample
            view.setUint16(34, bitDepth, true);

            // Data chunk identifier
            view.setUint32(36, 0x64617461, false); // 'data'

            // Data chunk size
            view.setUint32(40, dataLength, true);

            return new Uint8Array(header);
        }
    </script>
</body>
</html>
